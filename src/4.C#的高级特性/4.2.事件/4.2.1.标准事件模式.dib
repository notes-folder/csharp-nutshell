#!meta

{"kernelInfo":{"defaultKernelName":"csharp","items":[{"aliases":[],"name":"csharp"}]}}

#!csharp

/*
    4.2.1 æ ‡å‡†äº‹ä»¶æ¨¡å¼
    .NET Frameworkä¸ºäº‹ä»¶ç¼–ç¨‹å®šä¹‰äº†ä¸€ä¸ªæ ‡å‡†æ¨¡å¼ï¼Œå®ƒçš„ç›®çš„å°±æ˜¯ä¿æŒæ¡†æ¶å’Œç”¨æˆ·ä»£ç çš„ä¸€è‡´æ€§ã€‚
    æ ‡å‡†äº‹ä»¶æ¨¡å¼çš„æ ¸å¿ƒæ˜¯System.EventArgsç±»ï¼Œä¸€ä¸ªé¢„å®šä¹‰çš„æ²¡æœ‰æˆå‘˜ï¼ˆä½†æ˜¯æœ‰ä¸€ä¸ªé™æ€çš„Emptyå±æ€§ï¼‰çš„ç±»ã€‚
    EventArgsæ˜¯ä¸ºäº‹ä»¶ä¼ é€’ä¿¡æ¯çš„åŸºç±»ã€‚
*/

//åœ¨Stockç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç»§æ‰¿EventArgsä»¥ä¾¿åœ¨PriceChangedäº‹ä»¶è§¦å‘æ—¶ä¼ é€’æ–°çš„å’Œæ—§çš„Priceå€¼ï¼š
public class PriceChangedEventArgs : System.EventArgs
{
    public readonly decimal LastPrice;
    public readonly decimal NewPrice;

    public PriceChangedEventArgs(decimal lastPrice, decimal newPrice)
    {
        LastPrice = lastPrice;
        NewPrice = newPrice;
    }
}

#!csharp

/*
    è€ƒè™‘åˆ°å¤ç”¨æ€§ï¼ŒEventArgså­ç±»åº”å½“æ ¹æ®å®ƒåŒ…å«çš„ä¿¡æ¯æ¥å‘½åï¼ˆè€Œéæ ¹æ®ä½¿ç”¨å®ƒçš„äº‹ä»¶å‘½åï¼‰ã€‚
    å®ƒä¸€èˆ¬å°†æ•°æ®ä»¥å±æ€§æˆ–åªè¯»å­—æ®µçš„æ–¹å¼æš´éœ²ç»™å¤–ç•Œã€‚
    EventArgså­ç±»å°±ä½åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯é€‰æ‹©æˆ–è€…å®šä¹‰äº‹ä»¶çš„å§”æ‰˜äº†ã€‚
    è¿™ä¸€æ­¥éœ€è¦éµå¾ªä¸‰æ¡è§„åˆ™ï¼š
        Â· å§”æ‰˜å¿…é¡»ä»¥voidä½œä¸ºè¿”å›å€¼ã€‚
        Â· å§”æ‰˜å¿…é¡»æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯objectç±»å‹ï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™æ˜¯EventArgsçš„å­ç±»ã€‚
            ç¬¬ä¸€ä¸ªå‚æ•°è¡¨æ˜äº†äº‹ä»¶çš„å¹¿æ’­è€…ï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™åŒ…å«äº†éœ€è¦ä¼ é€’çš„é¢å¤–ä¿¡æ¯ã€‚
        Â· å§”æ‰˜çš„åç§°å¿…é¡»ä»¥EventHandlerç»“å°¾ã€‚
*/

// æ¡†æ¶å®šä¹‰äº†ä¸€ä¸ªåä¸ºSystem.EventHandler<>çš„æ³›å‹å§”æ‰˜ï¼Œè¯¥å§”æ‰˜æ»¡è¶³ä»¥ä¸Šæåˆ°çš„ä¸‰ä¸ªæ¡ä»¶ï¼š
public delegate void EventHandler<TEventArgs>(object source, TEventArgs e) where TEventArgs : EventArgs;

// ğŸ¦ åœ¨æ³›å‹å‡ºç°ä¹‹å‰ï¼ˆC# 2.0ä¹‹å‰ï¼‰ï¼Œæˆ‘ä»¬åªèƒ½ä»¥å¦‚ä¸‹çš„æ–¹å¼ä¹¦å†™è‡ªå®šä¹‰å§”æ‰˜ï¼š
public delegate void PriceChangedHandler(object sender, PriceChangedEventArgs e);

// å‡ºäºå†å²åŸå› ï¼Œæ¡†æ¶ä¸­çš„å¤§éƒ¨åˆ†äº‹ä»¶ä½¿ç”¨çš„å§”æ‰˜æ˜¯è¿™æ ·å®šä¹‰çš„ã€‚

#!csharp

// æ¥ä¸‹æ¥å°±æ˜¯å®šä¹‰é€‰å®šå§”æ‰˜ç±»å‹çš„äº‹ä»¶äº†ã€‚
// è¿™é‡Œä½¿ç”¨æ³›å‹çš„EventHandlerå§”æ‰˜ï¼š
public class Stock
{
    public event EventHandler<PriceChangedEventArgs> PriceChanged;
}

#!csharp

// æœ€åï¼Œè¯¥æ¨¡å¼éœ€è¦ç¼–å†™ä¸€ä¸ªprotectedçš„è™šæ–¹æ³•æ¥è§¦å‘äº‹ä»¶ã€‚
// æ–¹æ³•åå¿…é¡»å’Œäº‹ä»¶åç§°ä¸€è‡´ï¼Œä»¥Onä½œä¸ºå‰ç¼€ï¼Œå¹¶æ¥æ”¶å”¯ä¸€çš„EventArgså‚æ•°ï¼š
public class Stock
{

    public event EventHandler<PriceChangedEventArgs> PriceChanged;

    protected virtual void OnPriceChanged(PriceChangedEventArgs e)
    {
        if (PriceChanged != null)
        {
            PriceChanged(this, e);
        }
    }
}

// ğŸ¦ åœ¨å¤šçº¿ç¨‹æƒ…å½¢ä¸‹ï¼ˆè§ç¬¬14ç« ï¼‰ï¼Œä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåœ¨æµ‹è¯•å’Œè°ƒç”¨å§”æ‰˜ä¹‹å‰ï¼Œéœ€è¦å°†å®ƒä¿å­˜åœ¨ä¸€ä¸ªä¸´æ—¶å˜é‡ä¸­ï¼š
// var temp = PriceChanged;
// if (temp ! = null) temp (this, e);

// æˆ‘ä»¬å¯ä»¥ä½¿ç”¨C# 6çš„nullæ¡ä»¶è¿ç®—ç¬¦æ¥é¿å…ä¸´æ—¶å˜é‡çš„å£°æ˜ï¼š
// PriceChanged?.Invoke(this, e);

// è¿™ç§æ–¹å¼æ—¢çº¿ç¨‹å®‰å…¨åˆä¹¦å†™ç®€æ˜ï¼Œæ˜¯ç°é˜¶æ®µæœ€å¥½çš„äº‹ä»¶è§¦å‘æ–¹å¼äº†ã€‚

#!csharp

// è¿™æ ·å°±æä¾›äº†ä¸€ä¸ªå­ç±»å¯ä»¥è°ƒç”¨æˆ–é‡å†™äº‹ä»¶çš„å…³é”®ç‚¹ï¼ˆå‡å¦‚ä¸æ˜¯å¯†å°ç±»çš„è¯ï¼‰ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„ä¾‹å­ï¼š
using System;

public class PriceChangedEventArgs : EventArgs
{
    public readonly decimal LastPrice;
    public readonly decimal NewPrice;
    public PriceChangedEventArgs(decimal lastPrice, decimal newPrice)
    {
        LastPrice = lastPrice; NewPrice = newPrice;
    }
}

public class Stock
{
    string symbol;
    decimal price;

    public Stock(string symbol) { this.symbol = symbol; }

    public event EventHandler<PriceChangedEventArgs> PriceChanged;

    protected virtual void OnPriceChanged(PriceChangedEventArgs e)
    {
        PriceChanged?.Invoke(this, e);
    }

    public decimal Price
    {
        get { return price; }
        set
        {
            if (price == value) return;
            decimal oldPrice = price;
            price = value;
            OnPriceChanged(new PriceChangedEventArgs(oldPrice, price));
        }
    }
}

void stock_PriceChanged(object sender, PriceChangedEventArgs e)
{
    if ((e.NewPrice - e.LastPrice) / e.LastPrice > 0.1M)
        Console.WriteLine("Alert, 10% stock price increase! ");
}

Stock stock = new Stock("THPW");
stock.Price = 27.10M;
// Register with the PriceChanged event
stock.PriceChanged += stock_PriceChanged;
stock.Price = 31.59M;
